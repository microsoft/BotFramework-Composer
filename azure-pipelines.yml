trigger:
  - master

pr:
  autoCancel: true
  branches:
    include:
      - '*'

variables:
  containerRegistry: 'bfc-docker-registry'
  dockerRepository: 'composer'
  latestImage: bfctest.azurecr.io/composer:latest

stages:
  - stage: build
    jobs:
      - job: buildAndPush
        displayName: Build and Push Docker Image
        steps:
          - task: Docker@2
            displayName: Docker Login
            inputs:
              containerRegistry: $(containerRegistry)
              command: 'login'
          - script: docker pull $(latestImage) || true
            displayName: Pull latest image
          - task: Docker@2
            displayName: Build Image
            inputs:
              containerRegistry: $(containerRegistry)
              repository: $(dockerRepository)
              command: 'build'
              Dockerfile: 'Composer/Dockerfile.ci'
              buildContext: 'Composer/'
              tags: |
                $(Build.BuildId)
                latest
              arguments: --cache-from $(latestImage)
          - task: Docker@2
            displayName: Push Image
            inputs:
              containerRegistry: $(containerRegistry)
              repository: $(dockerRepository)
              command: 'push'
              tags: |
                $(Build.BuildId)
                latest

  # - stage: e2e
  #   jobs:
  #     - job: e2e
  #       strategy:
  #         parallel: 4
  #       pool:
  #         vmImage: ubuntu-latest

  #       steps:

  #         - script: |
  #             yarn start &
  #             npx cypress run --browser chrome --record --parallel --ci-build-id $BUILD_BUILDNUMBER --group "Azure CI"
  #           displayName: yarn test:integration
  #           workingDirectory: Composer
  #           continueOnError: true
  #           env:
  #             CYPRESS_RECORD_KEY: $(CYPRESS_RECORD_KEY)
  #             CYPRESS_VIDEO: true
  #             CYPRESS_VIDEO_UPLOAD_ON_PASSES: true
  #             # avoid warnings about terminal
  #             TERM: xterm
